{% extends "base.html" %}
{% block content %}
<h2>üîç Buscar Cliente</h2>

<!-- üîÑ Buscador -->
<form method="POST" class="mb-3">
  <div class="input-group" style="max-width: 400px;">
    <input type="text" id="criterio" name="q" class="form-control"
           placeholder="Ingrese DNI o Apellidos" required autocomplete="off">
    <button type="submit" class="btn btn-primary">Buscar</button>
  </div>
</form>

{% if cliente %}
  {% if not separaciones and not compras_contado and not compras_credito and not historial %}
    <div class="alert alert-warning text-center">
      Este cliente no tiene lotes activos ni historial.
    </div>
  {% else %}
    {% if separaciones or compras_contado or compras_credito %}
  <div class="card mb-4">
  <div class="card-header bg-primary text-white">Informaci√≥n del Cliente</div>
  <div class="card-body">
    <div class="row">
      
      <!-- Informaci√≥n del cliente -->
      <div class="col-md-7">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Nombre:</strong> {{ cliente.nombre }}</p>
            <p><strong>Apellidos:</strong> {{ cliente.apellidos }}</p>
            <p><strong>DNI:</strong> {{ cliente.dni }}</p>
            <p><strong>Tel√©fono:</strong> {{ cliente.telefono }}</p>
            <p><strong>Correo:</strong> {{ cliente.correo }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Estado Civil:</strong> {{ cliente.estado_civil or "No registrada" }}</p>
            <p><strong>Ocupaci√≥n:</strong> {{ cliente.ocupacion or "No registrada" }}</p>
            <p><strong>Direcci√≥n:</strong> {{ cliente.direccion }}</p>
            <p><strong>Ciudad:</strong> {{ cliente.ciudad }}</p>
          </div>
        </div>
        <a href="{{ url_for('editar_cliente', cliente_id=cliente.id) }}" 
           class="btn btn-primary btn-sm mt-2">‚úèÔ∏è Editar Cliente</a>
      </div>

      <!-- Fotos DNI -->
      <div class="col-md-5 text-center">
        <div class="d-flex justify-content-center gap-3">
          {% if cliente.dni_frontal %}
            <div>
              <a href="{{ url_for('static', filename=cliente.dni_frontal) }}" target="_blank">
                <img src="{{ url_for('static', filename=cliente.dni_frontal) }}" 
                     class="img-thumbnail" style="max-width: 120px;">
              </a>
              <p class="text-muted small mt-1">DNI Frontal</p>
            </div>
          {% endif %}
          {% if cliente.dni_reverso %}
            <div>
              <a href="{{ url_for('static', filename=cliente.dni_reverso) }}" target="_blank">
                <img src="{{ url_for('static', filename=cliente.dni_reverso) }}" 
                     class="img-thumbnail" style="max-width: 120px;">
              </a>
              <p class="text-muted small mt-1">DNI Reverso</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal DNI Reverso -->
<div class="modal fade" id="modalReverso" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img src="{{ url_for('static', filename=cliente.dni_reverso) }}" class="img-fluid" alt="DNI Reverso">
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if separaciones %}
<h3>üü° Lotes Separados</h3>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Lote</th>
        <th>Monto</th>
        <th>Fecha</th>
        <th>Voucher</th>
        <th>Acciones</th>
        <th>Vendido por</th>  <!-- üëà Nueva columna -->
      </tr>
    </thead>
    <tbody>
      {% for s in separaciones %}
      <tr>
        <td>Mz {{ s.lote.manzana }} - Lt {{ s.lote.numero }}</td>
        <td>S/ {{ "%.2f"|format(s.monto) }}</td>
        <td>{{ s.fecha.strftime("%d/%m/%Y") }}</td>

        <td>
          {% if s.boucher %}
            <a href="{{ url_for('static', filename=s.boucher) }}" target="_blank" class="btn btn-sm btn-info">
              üìé Ver Voucher
            </a>
          {% else %}
            <span class="text-muted">No disponible</span>
          {% endif %}
        </td>

        <td>
          <div class="d-flex flex-column gap-1">
            <!-- ‚úÖ Cambiar este form por un enlace -->
            <a href="{{ url_for('registrar_compra', sep_id=s.id) }}" 
              class="btn btn-success btn-sm">
              üí∞ Convertir a Compra
            </a>

            {% if current_user.rol == 'admin' %}
            <form action="{{ url_for('liberar_separacion', sep_id=s.id) }}" method="POST">
              <button type="submit" class="btn btn-danger btn-sm" 
                      onclick="return confirm('¬øEliminar esta separaci√≥n?');">
                üóëÔ∏è Eliminar
              </button>
            </form>
            {% endif %}
          </div>
        </td>

        <td>
          {% if s.usuario %}
            {{ s.usuario.username }}
          {% else %}
            <span class="text-muted">No registrado</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}


<!-- ===============================
     COMPRAS AL CONTADO
================================ -->
{% if compras_contado %}
<h3>üü¢ Compras al Contado</h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead class="table-dark">
<tr>
  <th>Lote</th>
  <th>Estado</th>
  <th>Precio</th>
  <th>Fecha</th>
  <th>Boucher</th>
  <th>Acta de Entrega</th>
  <th>Comentario</th>
  <th>Vendedor</th>
</tr>
</thead>
<tbody>
{% for c in compras_contado %}
<tr>
  <td>Mz {{ c.lote.manzana }} - Lt {{ c.lote.numero }}</td>
  <td>
    <span class="badge bg-success">‚úÖ CANCELADO</span>
    {% if c.fecha_cancelacion %}
      <br><small class="text-muted">{{ c.fecha_cancelacion.astimezone(pytz.timezone('America/Lima')).strftime('%d/%m/%Y') }}</small>
    {% endif %}
  </td>
  <td>S/ {{ "%.2f"|format(c.precio) }}</td>
  <td>{{ c.fecha_compra.strftime("%d/%m/%Y") }}</td>
  <td>
    {% if c.boucher_inicial %}
      <a href="{{ url_for('static', filename=c.boucher_inicial) }}" target="_blank" class="btn btn-sm btn-primary">Ver Boucher</a>
      {% if current_user.rol == "admin" %}
      <form action="{{ url_for('liberar_lote', id=c.lote_id, tipo='compra') }}" method="POST" style="display:inline;">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¬øSeguro que deseas liberar esta compra?');">Liberar</button>
      </form>
      {% endif %}
    {% else %}
      <span class="text-muted">No disponible</span>
    {% endif %}
  </td>
  <td>
  {% if c.acta_entrega %}
    <a href="{{ url_for('static', filename=c.acta_entrega) }}" target="_blank" class="btn btn-success btn-sm mb-1 w-100">
      ‚úÖ Ver Acta
    </a>
  {% else %}
    <form action="{{ url_for('subir_acta', compra_id=c.id) }}" method="POST" enctype="multipart/form-data" class="d-flex flex-column align-items-start gap-1">
      <input type="file" name="acta_file" class="form-control form-control-sm" required>
      <button type="submit" class="btn btn-warning btn-sm w-100">
        üìÑ Subir Acta
      </button>
    </form>
  {% endif %}
  {% if c.entregado %}
    <span class="badge bg-success mt-1">Entregado</span>
  {% else %}
    <span class="badge bg-secondary mt-1">Pendiente</span>
  {% endif %}
</td>
  <td>
    <form action="{{ url_for('agregar_comentario', compra_id=c.id) }}" method="POST" class="d-flex">
      <textarea name="comentario" rows="3" class="form-control form-control-sm me-2"
      placeholder="Escribe un comentario">{{ c.comentario or '' }}</textarea>
      <button type="submit" class="btn btn-primary btn-sm">üíæ</button>
    </form>
  </td>
  <td>{{ c.usuario.username if c.usuario else "No registrado" }}</td>
</tr>

<!-- üé® DOCUMENTOS ADICIONALES - CONTADO -->
<tr>
  <td colspan="8" class="bg-light">
    <div class="p-3 rounded shadow-sm bg-white border">
      <h6 class="text-primary mb-3"><i class="fas fa-folder-open"></i> Documentos Adicionales</h6>
      <div class="row g-3">

        <!-- Escritura -->
        <div class="col-md-4">
          <div class="card h-100 shadow-sm border-0 bg-light">
            <div class="card-body">
              <strong class="d-block mb-2"><i class="fas fa-file-contract"></i> Escritura/Minuta</strong>
              {% if c.escritura %}
                <a href="{{ url_for('static', filename=c.escritura) }}" target="_blank" class="btn btn-success btn-sm me-2"><i class="fas fa-eye"></i> Ver</a>
                {% if current_user.rol == 'admin' %}
                <form method="POST" action="{{ url_for('eliminar_documento', compra_id=c.id, tipo='escritura') }}" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                </form>
                {% endif %}
              {% else %}
                <span class="text-muted d-block mb-2">No subido</span>
                <button class="btn btn-outline-primary btn-sm mt-1" type="button" data-bs-toggle="collapse" data-bs-target="#formEscritura{{ c.id }}"><i class="fas fa-upload"></i> Subir Escritura</button>
                <div class="collapse mt-3" id="formEscritura{{ c.id }}">
                  <form method="POST" action="{{ url_for('subir_documentos', compra_id=c.id) }}" enctype="multipart/form-data">
                    <input type="hidden" name="tipo_documento" value="escritura">
                    <div class="mb-2"><input type="file" name="archivo" class="form-control form-control-sm" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required></div>
                    <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-upload"></i> Guardar</button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Otros Documentos -->
        <div class="col-md-8">
          <div class="card h-100 shadow-sm border-0 bg-light">
            <div class="card-body">
              <strong class="d-block mb-2"><i class="fas fa-copy"></i> Otros Documentos</strong>
              {% if c.otros_documentos %}
                {% set otros = c.otros_documentos | from_json %}
                <div class="d-flex flex-wrap gap-2">
                  {% for doc in otros %}
                    <div class="d-inline-flex align-items-center bg-info text-white px-2 py-1 rounded">
                      <a href="{{ url_for('static', filename=doc.ruta) }}" target="_blank" class="text-white text-decoration-none me-2"><i class="fas fa-file-alt"></i> {{ doc.nombre }}</a>
                      {% if current_user.rol == 'admin' %}
                      <form method="POST" action="{{ url_for('eliminar_documento', compra_id=c.id, tipo='otro_' + loop.index0|string) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-link text-white p-0"><i class="fas fa-times"></i></button>
                      </form>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-muted">No hay documentos adicionales</span>
              {% endif %}
              <button class="btn btn-outline-primary btn-sm mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#formOtros{{ c.id }}"><i class="fas fa-upload"></i> Agregar Documento</button>
              <div class="collapse mt-3" id="formOtros{{ c.id }}">
                <form method="POST" action="{{ url_for('subir_documentos', compra_id=c.id) }}" enctype="multipart/form-data">
                  <input type="hidden" name="tipo_documento" value="otro">
                  <div class="mb-2"><input type="text" name="nombre_documento" class="form-control form-control-sm" placeholder="Ej: Plano, Autorizaci√≥n, etc." required></div>
                  <div class="mb-2"><input type="file" name="archivo" class="form-control form-control-sm" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required></div>
                  <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-upload"></i> Guardar</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

<!-- ===============================
     COMPRAS A CR√âDITO
================================ -->
{% if compras_credito %}
<h3>üü° Compras a Cr√©dito</h3>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead class="table-dark">
<tr>
  <th>Lote</th>
  <th>Estado</th>
  <th>Precio</th>
  <th>Inicial</th>
  <th>Cuotas Pagadas</th>
  <th>Total Cuotas</th>
  <th>Fecha</th>
  <th>Voucher</th>
  <th>Acci√≥n</th>
  <th>Acta de Entrega</th>
  <th>Comentario</th>
  <th>Vendedor</th>
</tr>
</thead>
<tbody>
{% for c in compras_credito %}
<tr>
  <td>Mz {{ c.lote.manzana }} - Lt {{ c.lote.numero }}</td>
  <td>
    {% if c.cancelado %}
      <span class="badge bg-success">‚úÖ CANCELADO</span>
      {% if c.fecha_cancelacion %}
        <br><small class="text-muted">{{ c.fecha_cancelacion.astimezone(pytz.timezone('America/Lima')).strftime('%d/%m/%Y') }}</small>
      {% endif %}
    {% else %}
      {% set cuotas_pagadas = c.cuotas|selectattr('pagada', 'equalto', True)|list|length %}
      <span class="badge bg-warning text-dark">
        üìä {{ cuotas_pagadas }}/{{ c.cuotas_total }}
      </span>
    {% endif %}
  </td>
  <td>S/ {{ "%.2f"|format(c.precio) }}</td>
  <td>S/ {{ "%.2f"|format(c.inicial) }}</td>
  <td>{{ c.cuotas | selectattr("pagada") | list | length }}</td>
  <td>{{ c.cuotas_total }}</td>
  <td>{{ c.fecha_compra.strftime("%d/%m/%Y") }}</td>
  <td>
  {% if c.boucher_inicial %}
    <a href="{{ url_for('static', filename=c.boucher_inicial) }}" target="_blank" class="btn btn-sm btn-primary">Ver Voucher</a>
  {% else %}
    <span class="text-muted">No disponible</span>
  {% endif %}
</td>

<td>
  <a href="{{ url_for('detalle_cuotas', compra_id=c.id) }}" class="btn btn-sm btn-info">Ver Cuotas</a>

  {% if current_user.rol == "admin" %}
  <form action="{{ url_for('liberar_lote', id=c.lote_id, tipo='compra') }}" method="POST" style="display:inline;">
    <button type="submit" class="btn btn-danger btn-sm mt-1"
            onclick="return confirm('¬øSeguro que deseas liberar esta compra a cr√©dito?');">
      Liberar
    </button>
  </form>
  {% endif %}
</td>
    <td>
  {% if c.acta_entrega %}
    <a href="{{ url_for('static', filename=c.acta_entrega) }}" target="_blank" class="btn btn-success btn-sm mb-1 w-100">
      ‚úÖ Ver Acta
    </a>
  {% else %}
    <form action="{{ url_for('subir_acta', compra_id=c.id) }}" method="POST" enctype="multipart/form-data" class="d-flex flex-column align-items-start gap-1">
      <input type="file" name="acta_file" class="form-control form-control-sm" required>
      <button type="submit" class="btn btn-warning btn-sm w-100">
        üìÑ Subir Acta
      </button>
    </form>
  {% endif %}
  {% if c.entregado %}
    <span class="badge bg-success mt-1">Entregado</span>
  {% else %}
    <span class="badge bg-secondary mt-1">Pendiente</span>
  {% endif %}
</td>
  <td>
    <form action="{{ url_for('agregar_comentario', compra_id=c.id) }}" method="POST" class="mt-1">
  <div class="input-group">
    <textarea name="comentario" 
              rows="3" 
              class="form-control form-control-sm"
              style="min-width: 250px; max-width: 100%; resize: vertical;"
              placeholder="Escribe un comentario">{{ c.comentario or '' }}</textarea>
    <button type="submit" class="btn btn-primary btn-sm">
      üíæ
    </button>
  </div>
</form>
  </td>
  <td>{{ c.usuario.username if c.usuario else "No registrado" }}</td>
</tr>

<!-- üé® DOCUMENTOS ADICIONALES - CR√âDITO -->
<tr>
  <td colspan="12" class="bg-light">
    <div class="p-3 rounded shadow-sm bg-white border">
      <h6 class="text-primary mb-3"><i class="fas fa-folder-open"></i> Documentos Adicionales</h6>
      
      <!-- ‚úÖ Mostrar alerta si est√° cancelado -->
      {% if c.cancelado %}
      <div class="alert alert-success mb-3">
        <strong>üéâ Pagado completamente</strong>
        {% if c.fecha_cancelacion %}
          <br>Fecha: {{ c.fecha_cancelacion.astimezone(pytz.timezone('America/Lima')).strftime('%d/%m/%Y %H:%M') }}
        {% endif %}
      </div>
      {% endif %}
      
      <div class="row g-3">

        <!-- Escritura -->
        <div class="col-md-4">
          <div class="card h-100 shadow-sm border-0 bg-light">
            <div class="card-body">
              <strong class="d-block mb-2"><i class="fas fa-file-contract"></i> Escritura/Minuta</strong>
              {% if c.escritura %}
                <a href="{{ url_for('static', filename=c.escritura) }}" target="_blank" class="btn btn-success btn-sm me-2"><i class="fas fa-eye"></i> Ver</a>
                {% if current_user.rol == 'admin' %}
                <form method="POST" action="{{ url_for('eliminar_documento', compra_id=c.id, tipo='escritura') }}" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                </form>
                {% endif %}
              {% else %}
                <span class="text-muted d-block mb-2">No subido</span>
                <button class="btn btn-outline-primary btn-sm mt-1" type="button" data-bs-toggle="collapse" data-bs-target="#formEscritura{{ c.id }}"><i class="fas fa-upload"></i> Subir Escritura</button>
                <div class="collapse mt-3" id="formEscritura{{ c.id }}">
                  <form method="POST" action="{{ url_for('subir_documentos', compra_id=c.id) }}" enctype="multipart/form-data">
                    <input type="hidden" name="tipo_documento" value="escritura">
                    <div class="mb-2"><input type="file" name="archivo" class="form-control form-control-sm" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required></div>
                    <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-upload"></i> Guardar</button>
                  </form>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Otros Documentos -->
        <div class="col-md-8">
          <div class="card h-100 shadow-sm border-0 bg-light">
            <div class="card-body">
              <strong class="d-block mb-2"><i class="fas fa-copy"></i> Otros Documentos</strong>
              {% if c.otros_documentos %}
                {% set otros = c.otros_documentos | from_json %}
                <div class="d-flex flex-wrap gap-2">
                  {% for doc in otros %}
                    <div class="d-inline-flex align-items-center bg-info text-white px-2 py-1 rounded">
                      <a href="{{ url_for('static', filename=doc.ruta) }}" target="_blank" class="text-white text-decoration-none me-2"><i class="fas fa-file-alt"></i> {{ doc.nombre }}</a>
                      {% if current_user.rol == 'admin' %}
                      <form method="POST" action="{{ url_for('eliminar_documento', compra_id=c.id, tipo='otro_' + loop.index0|string) }}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-link text-white p-0"><i class="fas fa-times"></i></button>
                      </form>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <span class="text-muted">No hay documentos adicionales</span>
              {% endif %}
              <button class="btn btn-outline-primary btn-sm mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#formOtros{{ c.id }}"><i class="fas fa-upload"></i> Agregar Documento</button>
              <div class="collapse mt-3" id="formOtros{{ c.id }}">
                <form method="POST" action="{{ url_for('subir_documentos', compra_id=c.id) }}" enctype="multipart/form-data">
                  <input type="hidden" name="tipo_documento" value="otro">
                  <div class="mb-2"><input type="text" name="nombre_documento" class="form-control form-control-sm" placeholder="Ej: Plano, Autorizaci√≥n, etc." required></div>
                  <div class="mb-2"><input type="file" name="archivo" class="form-control form-control-sm" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required></div>
                  <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-upload"></i> Guardar</button>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}
{% endif %}
{% elif request.method == "POST" %}
  <div class="alert alert-warning">No se encontr√≥ ning√∫n cliente con ese DNI o apellido.</div>
{% endif %}

<!-- ==========================
     AUTOCOMPLETE JAVASCRIPT
=========================== -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script>
$(function() {
  $("#criterio").autocomplete({
    source: "{{ url_for('autocomplete_clientes') }}",
    minLength: 2,
    select: function(event, ui) {
      window.location.href = "/ver_cliente?cliente_id=" + ui.item.id;
    }
  });
});

// Mostrar u ocultar el campo de nombre personalizado
function toggleNombreDocumento(compraId) {
  const select = document.getElementById('tipoDoc' + compraId);
  const nombreDiv = document.getElementById('nombreDocDiv' + compraId);
  if (select && nombreDiv) {
    nombreDiv.style.display = (select.value === 'otro') ? 'block' : 'none';
  }
}
</script>

<!-- ‚úÖ Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}