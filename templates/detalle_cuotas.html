{% extends "base.html" %}
{% block content %}
<h2>üìë Detalle de Cuotas - Lote Mz {{ compra.lote.manzana|upper }} Lt {{ compra.lote.numero }}</h2>

<!-- ‚úÖ NUEVO: Alerta de estado de cancelaci√≥n -->
{% if compra.cancelado %}
<div class="alert alert-success mb-4">
  <h4 class="alert-heading">üéâ ¬°Compra Totalmente Cancelada!</h4>
  {% if compra.fecha_cancelacion %}
  <p class="mb-0">
    <strong>Fecha de cancelaci√≥n:</strong> 
    {{ compra.fecha_cancelacion.astimezone(pytz.timezone('America/Lima')).strftime('%d/%m/%Y %H:%M') }}
  </p>
  {% endif %}
</div>
{% else %}
<div class="alert alert-info mb-4">
  {% set cuotas_pagadas = compra.cuotas|selectattr('pagada', 'equalto', True)|list|length %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <strong>Estado:</strong> Pago en proceso
      <br>
      <strong>Progreso:</strong> {{ cuotas_pagadas }} / {{ compra.cuotas_total }} cuotas pagadas
    </div>
    <h3 class="mb-0 text-primary">{{ (cuotas_pagadas / compra.cuotas_total * 100)|round|int }}%</h3>
  </div>
  <div class="progress" style="height: 25px;">
    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
         role="progressbar" 
         style="width: {{ (cuotas_pagadas / compra.cuotas_total * 100)|round }}%">
      {{ (cuotas_pagadas / compra.cuotas_total * 100)|round|int }}%
    </div>
  </div>
</div>
{% endif %}

<div class="card mb-4">
  <div class="card-header bg-primary text-white">Informaci√≥n de la Compra</div>
  <div class="card-body row">
    <div class="col-md-6">
      <p><strong>Cliente:</strong> {{ compra.cliente.nombre }} {{ compra.cliente.apellidos }} (DNI: {{ compra.cliente.dni }})</p>
      <p><strong>Lote:</strong> Mz {{ compra.lote.manzana }} - Lt {{ compra.lote.numero }}</p>
      <p><strong>Precio:</strong> S/ {{ "%.2f"|format(compra.precio) }}</p>
    </div>
    <div class="col-md-6">
      <p><strong>Inicial:</strong> S/ {{ "%.2f"|format(compra.inicial) }}</p>
      <p><strong>Cuotas Totales:</strong> {{ compra.cuotas_total }}</p>
      <p><strong>Fecha de Compra:</strong> {{ compra.fecha_compra.strftime("%d/%m/%Y") }}</p>
      <!-- ‚úÖ NUEVO: Mostrar estado de cancelaci√≥n -->
      <p>
        <strong>Estado:</strong> 
        {% if compra.cancelado %}
          <span class="badge bg-success">‚úÖ CANCELADO</span>
        {% else %}
          <span class="badge bg-warning text-dark">‚è≥ EN PROCESO</span>
        {% endif %}
      </p>
    </div>
  </div>
</div>

<table class="table table-bordered table-striped">
  <thead class="table-dark text-center">
    <tr>
      <th>#</th>
      <th>Monto</th>
      <th>Vencimiento</th>
      <th>Estado</th>
      <th>D√≠as de atraso</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody>
    {% for cuota in compra.cuotas|sort(attribute='numero') %}
    <tr class="text-center">
      <td>{{ cuota.numero }}</td>
      <td>S/ {{ "%.2f"|format(cuota.monto) }}</td>
      <td>{{ cuota.fecha_vencimiento.strftime("%d/%m/%Y") }}</td>
      <td>
        {% if cuota.pagada %}
          <span class="badge bg-success">‚úÖ Pagada</span>
        {% elif cuota.fecha_vencimiento < now %}
          <span class="badge bg-danger">‚ùå Vencida</span>
        {% else %}
          <span class="badge bg-warning text-dark">‚è≥ Pendiente</span>
        {% endif %}
      </td>
      <td>
        {% if not cuota.pagada and cuota.fecha_vencimiento < now %}
          <span class="text-danger fw-bold">{{ (now.date() - cuota.fecha_vencimiento.date()).days }} d√≠as</span>
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if not cuota.pagada %}
          {# ‚úÖ Verificar si hay cuotas anteriores sin pagar #}
          {% set hay_cuota_anterior_pendiente = compra.cuotas|selectattr('numero', 'lt', cuota.numero)|selectattr('pagada', 'equalto', False)|list|length > 0 %}
          
          {% if hay_cuota_anterior_pendiente %}
            <button class="btn btn-sm btn-secondary" disabled title="Debes pagar las cuotas anteriores primero">
              üîí Pagar (Bloqueado)
            </button>
          {% else %}
            <form method="POST" action="{{ url_for('pagar_cuota') }}" enctype="multipart/form-data" class="d-flex flex-column gap-1">
              <input type="hidden" name="cuota_id" value="{{ cuota.id }}">
              <input type="file" name="boucher_cuota" accept="image/*" required class="form-control form-control-sm">
              <button type="submit" class="btn btn-sm btn-success">üí∞ Pagar</button>
            </form>
          {% endif %}
        {% else %}
          <div class="d-flex flex-column gap-1 align-items-center">
            {% if cuota.pago and cuota.pago.boucher %}
              <a href="{{ url_for('static', filename=cuota.pago.boucher) }}" target="_blank" class="btn btn-sm btn-primary">
                üìÑ Ver Boucher
              </a>
              <!-- üî¥ NUEVO: Bot√≥n para eliminar voucher -->
              <form method="POST" action="{{ url_for('eliminar_voucher_cuota', cuota_id=cuota.id) }}" 
                    style="display:inline;" 
                    onsubmit="return confirm('¬øEliminar este voucher?');">
                <button type="submit" class="btn btn-sm btn-danger">
                  üóëÔ∏è Eliminar
                </button>
              </form>
            {% else %}
              <span class="text-muted small">Sin voucher</span>
            {% endif %}
          </div>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ‚úÖ Resumen de pagos -->
<div class="card mt-4">
  <div class="card-header bg-secondary text-white">
    üí∞ Resumen de Pagos
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3">
        <h6>Total a Pagar</h6>
        <p class="h4 text-primary">S/ {{ "%.2f"|format(compra.precio) }}</p>
      </div>
      <div class="col-md-3">
        <h6>Inicial Pagado</h6>
        <p class="h4 text-success">S/ {{ "%.2f"|format(compra.inicial) }}</p>
      </div>
      <div class="col-md-3">
        <h6>Pagado en Cuotas</h6>
        {% set monto_cuotas_pagadas = compra.cuotas|selectattr('pagada', 'equalto', True)|sum(attribute='monto') %}
        <p class="h4 text-success">S/ {{ "%.2f"|format(monto_cuotas_pagadas) }}</p>
      </div>
      <div class="col-md-3">
        <h6>Saldo Pendiente</h6>
        {% set saldo = compra.precio - compra.inicial - monto_cuotas_pagadas %}
        <p class="h4 {{ 'text-success' if saldo == 0 else 'text-danger' }}">
          S/ {{ "%.2f"|format(saldo) }}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n volver ahora incluye cliente_id -->
<a href="{{ url_for('ver_cliente', cliente_id=compra.cliente.id) }}" class="btn btn-secondary mt-3">‚¨Ö Volver al Cliente</a>
{% endblock %}