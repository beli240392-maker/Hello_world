{% extends "base.html" %}
{% block content %}
<h2>ðŸ“Š Reportes</h2>

<!-- Filtro por fecha -->
<form method="get" class="mb-3 d-flex align-items-center gap-2">
  <input type="date" name="fecha" class="form-control w-auto" value="{{ fecha }}">
  <button type="submit" class="btn btn-primary">Filtrar</button>
</form>
<a href="{{ url_for('exportar_ventas') }}" class="btn btn-success float-end mb-3">
  ðŸ“¤ Exportar Ventas
</a>

<div class="row mb-4 text-center">
  <div class="col-md-3">
    <div class="card border-danger">
      <div class="card-body">
        <h6 class="card-title">Separaciones activas</h6>
        <h3 class="text-danger">{{ separaciones|length }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-success">
      <div class="card-body">
        <h6 class="card-title">Compras al contado</h6>
        <h3 class="text-success">{{ compras_contado|length }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-warning">
      <div class="card-body">
        <h6 class="card-title">Compras a crÃ©dito</h6>
        <h3 class="text-warning">{{ compras_credito|length }}</h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-dark">
      <div class="card-body">
        <h6 class="card-title">Cuotas vencidas</h6>
        <h3 class="text-dark">{{ cuotas_vencidas|length }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- Separaciones activas -->
<h4>ðŸ”´ Separaciones Activas</h4>
<table id="tabla-separaciones" class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Cliente</th>
      <th>TelÃ©fono</th>
      <th>Lote</th>
      <th>Monto</th>
      <th>Fecha</th>
      <th>DÃ­as activos</th>
      <th>Vendedor</th>
    </tr>
  </thead>
  <tbody>
    {% for s in separaciones %}
    <tr>
      <td>{{ s.cliente.nombre }} {{ s.cliente.apellidos }}</td>
      <td>ðŸ“ž {{ s.cliente.telefono or 'Sin telÃ©fono' }}</td>
      <td>Mz {{ s.lote.manzana }} - Lt {{ s.lote.numero }}</td>
      <td>S/ {{ "%.2f"|format(s.monto) }}</td>
      <td>{{ s.fecha.strftime("%d/%m/%Y") }}</td>
      <td>{{ (fecha - s.fecha.date()).days }}</td>
      <td>{{ s.usuario.username if s.usuario else "No registrado" }}</td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-center">No hay separaciones activas</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Compras al contado -->
<h4>ðŸŸ¢ Compras al contado</h4>
<table id="tabla-contado" class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Cliente</th>
      <th>DNI</th>
      <th>TelÃ©fono</th>
      <th>Lote</th>
      <th>Precio</th>
      <th>Fecha</th>
      <th>Vendedor</th>
    </tr>
  </thead>
  <tbody>
    {% for c in compras_contado %}
    <tr>
      <td>{{ c.cliente.nombre }} {{ c.cliente.apellidos }}</td>
      <td>{{ c.cliente.dni }}</td>
      <td>ðŸ“ž {{ c.cliente.telefono or 'Sin telÃ©fono' }}</td>
      <td>Mz {{ c.lote.manzana }} - Lt {{ c.lote.numero }}</td>
      <td class="text-start">S/ {{ "%.2f"|format(c.precio) }}</td>
      <td>{{ c.fecha_compra.strftime("%d/%m/%Y") }}</td>
      <td>{{ c.usuario.username if c.usuario else "No registrado" }}</td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-center">No hay compras al contado</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Compras a crÃ©dito -->
<h4>ðŸŸ¡ Compras a crÃ©dito</h4>
<table id="tabla-credito" class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Cliente</th>
      <th>TelÃ©fono</th>
      <th>Lote</th>
      <th>Inicial</th>
      <th>Cuotas</th>
      <th>Fecha</th>
      <th>Vendedor</th>
    </tr>
  </thead>
  <tbody>
    {% for c in compras_credito %}
    <tr>
      <td>{{ c.cliente.nombre }} {{ c.cliente.apellidos }}</td>
      <td>ðŸ“ž {{ c.cliente.telefono or 'Sin telÃ©fono' }}</td>
      <td>Mz {{ c.lote.manzana }} - Lt {{ c.lote.numero }}</td>
      <td>S/ {{ "%.2f"|format(c.inicial) }}</td>
      <td>{{ c.cuotas|selectattr("pagada", "equalto", True)|list|length }} / {{ c.cuotas_total }}</td>
      <td>{{ c.fecha_compra.strftime("%d/%m/%Y") }}</td>
      <td>{{ c.usuario.username if c.usuario else "No registrado" }}</td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-center">No hay compras a crÃ©dito</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Cuotas vencidas -->
<h4>âš« Cuotas vencidas</h4>
<table id="tabla-vencidas" class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Cliente</th>
      <th>TelÃ©fono</th>
      <th>Lote</th>
      <th>NÂ° Cuota</th>
      <th>Monto</th>
      <th>Vencimiento</th>
      <th>DÃ­as vencidos</th>
    </tr>
  </thead>
  <tbody>
    {% for q in cuotas_vencidas %}
    <tr>
      <td>{{ q.compra.cliente.nombre }} {{ q.compra.cliente.apellidos }}</td>
      <td>ðŸ“ž {{ q.compra.cliente.telefono or 'Sin telÃ©fono' }}</td>
      <td>Mz {{ q.compra.lote.manzana }} - Lt {{ q.compra.lote.numero }}</td>
      <td>{{ q.numero }}</td>
      <td>S/ {{ "%.2f"|format(q.monto) }}</td>
      <td>{{ q.fecha_vencimiento.strftime("%d/%m/%Y") }}</td>
      <td>{{ (fecha - q.fecha_vencimiento).days }}</td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-center">No hay cuotas vencidas</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Cuotas por vencer -->
<h4>ðŸ”µ Cuotas por vencer (7 dÃ­as)</h4>
<table id="tabla-por-vencer" class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Cliente</th>
      <th>TelÃ©fono</th>
      <th>Lote</th>
      <th>NÂ° Cuota</th>
      <th>Monto</th>
      <th>Vencimiento</th>
      <th>DÃ­as restantes</th>
    </tr>
  </thead>
  <tbody>
    {% for q in cuotas_por_vencer %}
    <tr>
      <td>{{ q.compra.cliente.nombre }} {{ q.compra.cliente.apellidos }}</td>
      <td>ðŸ“ž {{ q.compra.cliente.telefono or 'Sin telÃ©fono' }}</td>
      <td>Mz {{ q.compra.lote.manzana }} - Lt {{ q.compra.lote.numero }}</td>
      <td>{{ q.numero }}</td>
      <td>S/ {{ "%.2f"|format(q.monto) }}</td>
      <td>{{ q.fecha_vencimiento.strftime("%d/%m/%Y") }}</td>
      <td>{{ (q.fecha_vencimiento - fecha).days }}</td>
    </tr>
    {% else %}
    <tr><td colspan="7" class="text-center">No hay cuotas prÃ³ximas a vencer</td></tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
