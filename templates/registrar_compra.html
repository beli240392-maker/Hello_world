{% extends "base.html" %}
{% block content %}
<h2>Registrar Compra</h2>

{% if sep_id and separacion %}
<div class="alert alert-info">
  ‚ö†Ô∏è Est√°s convirtiendo una <strong>separaci√≥n</strong> en compra.<br>
  <strong>Lote:</strong> Mz {{ lote.manzana }} - Lt {{ lote.numero }} <br>
  <strong>Monto de separaci√≥n:</strong> S/ {{ "%.2f"|format(separacion.monto) }} <br>
  <strong>Fecha de separaci√≥n:</strong> {{ separacion.fecha.strftime("%d/%m/%Y") }}
</div>
{% endif %}

{% if cliente and cliente.id and not sep_id %}
<div class="alert alert-success">
  ‚úÖ Est√°s agregando un nuevo lote al cliente: <strong>{{ cliente.nombre }} {{ cliente.apellidos }}</strong> (DNI: {{ cliente.dni }})
</div>
{% endif %}

<form method="POST" enctype="multipart/form-data" class="row g-4">
  <!-- Datos del Cliente -->
  <div class="col-md-6">
    <h5>Datos del Cliente</h5>
    {% if cliente and cliente.id and not sep_id %}
      {# Cliente existente - mostrar como readonly #}
      <div class="mb-3">
        <label class="form-label">Nombre:</label>
        <input type="text" class="form-control" value="{{ cliente.nombre }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Apellidos:</label>
        <input type="text" class="form-control" value="{{ cliente.apellidos }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">DNI:</label>
        <input type="text" class="form-control" value="{{ cliente.dni }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Correo electr√≥nico:</label>
        <input type="email" class="form-control" value="{{ cliente.correo or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Estado Civil:</label>
        <input type="text" class="form-control" value="{{ cliente.estado_civil or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Ocupaci√≥n:</label>
        <input type="text" class="form-control" value="{{ cliente.ocupacion or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Tel√©fono:</label>
        <input type="text" class="form-control" value="{{ cliente.telefono or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Direcci√≥n:</label>
        <input type="text" class="form-control" value="{{ cliente.direccion or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      <div class="mb-3">
        <label class="form-label">Ciudad:</label>
        <input type="text" class="form-control" value="{{ cliente.ciudad or '' }}" readonly style="background-color: #e9ecef;">
      </div>
      {# Campos hidden para enviar los datos del cliente #}
      <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
      <input type="hidden" name="nombre" value="{{ cliente.nombre }}">
      <input type="hidden" name="apellidos" value="{{ cliente.apellidos }}">
      <input type="hidden" name="dni" value="{{ cliente.dni }}">
      <input type="hidden" name="correo" value="{{ cliente.correo or '' }}">
      <input type="hidden" name="estado_civil" value="{{ cliente.estado_civil or '' }}">
      <input type="hidden" name="ocupacion" value="{{ cliente.ocupacion or '' }}">
      <input type="hidden" name="telefono" value="{{ cliente.telefono or '' }}">
      <input type="hidden" name="direccion" value="{{ cliente.direccion or '' }}">
      <input type="hidden" name="ciudad" value="{{ cliente.ciudad or '' }}">
    {% else %}
      {# Nuevo cliente - campos editables #}
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre:</label>
        <input type="text" class="form-control" name="nombre" value="{{ cliente.nombre if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="apellidos" class="form-label">Apellidos:</label>
        <input type="text" class="form-control" name="apellidos" value="{{ cliente.apellidos if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="dni" class="form-label">DNI:</label>
        <input type="text" class="form-control" name="dni"
             value="{{ cliente.dni if cliente else '' }}"
             required 
             minlength="8" maxlength="15"
             oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'').slice(0,15)">
      </div>
      <div class="form-group">
          <label>Correo electr√≥nico:</label>
          <input type="email" name="correo" class="form-control" value="{{ cliente.correo if cliente else '' }}" placeholder="ejemplo@correo.com">
      </div>
      <div class="mb-3">
        <label for="estado_civil" class="form-label">Estado Civil</label>
        <input type="text" name="estado_civil" class="form-control" 
               value="{{ cliente.estado_civil if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="ocupacion" class="form-label">Ocupaci√≥n</label>
        <input type="text" name="ocupacion" class="form-control" 
               value="{{ cliente.ocupacion if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="telefono" class="form-label">Tel√©fono:</label>
        <input type="text" class="form-control" name="telefono" value="{{ cliente.telefono if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="direccion" class="form-label">Direcci√≥n:</label>
        <input type="text" class="form-control" name="direccion" value="{{ cliente.direccion if cliente else '' }}" required>
      </div>
      <div class="mb-3">
        <label for="ciudad" class="form-label">Ciudad:</label>
        <input type="text" class="form-control" name="ciudad" value="{{ cliente.ciudad if cliente else '' }}" required>
      </div>
    {% endif %}
  </div>

  <!-- Datos de la Compra -->
  <div class="col-md-6">
    <h5>Datos de la Compra</h5>

    <!-- Selecci√≥n de Manzana -->
    <div class="mb-3">
      <label for="manzana" class="form-label">Manzana:</label>
      <select id="manzana" name="manzana" class="form-control" required>
        <option value="">Seleccione una manzana</option>
        {% for mz, group in lotes|groupby("manzana") %}
          <option value="{{ mz }}" {% if lote and lote.manzana == mz %}selected{% endif %}>{{ mz }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Selecci√≥n de Lote -->
    <div class="mb-3">
      <label for="lote" class="form-label">Lote:</label>
      <select id="lote" name="lote" class="form-control" required>
        <option value="">Seleccione un lote</option>
      </select>
    </div>

    <!-- Precio -->
    <div class="mb-3">
      <label for="precio" class="form-label">Precio del Lote:</label>
      <input type="number" step="0.01" class="form-control" name="precio" 
             value="{{ lote.precio if lote else (separacion.monto if separacion else '') }}" required>
    </div>

    <div class="mb-3">
      <label for="forma_pago" class="form-label">Forma de Pago:</label>
      <select name="forma_pago" class="form-control" required>
        <option value="contado">Contado</option>
        <option value="credito">Cr√©dito</option>
      </select>
    </div>

    <!-- Campos de cr√©dito -->
    <div id="creditoFields" style="display: none;">
      <div class="mb-3">
        <label for="inicial" class="form-label">Inicial:</label>
        <input type="number" step="0.01" class="form-control" name="inicial">
      </div>

      <div class="mb-3">
        <label for="cuotas" class="form-label">Cantidad de Cuotas:</label>
        <input type="number" class="form-control" name="cuotas">
      </div>

      <div class="mb-3">
        <label for="interes" class="form-label">Inter√©s (%):</label>
        <input type="number" step="0.01" class="form-control" name="interes" value="0">
      </div>
    </div>

    <div class="mb-3">
      <label for="boucher_inicial" class="form-label">Boucher de pago (obligatorio):</label>
      <input type="file" class="form-control" name="boucher_inicial" required>
      {% if separacion and separacion.boucher %}
        <div class="mt-2">
          <p class="text-muted mb-1">Referencia - Boucher de separaci√≥n anterior:</p>
          <a href="{{ url_for('static', filename=separacion.boucher) }}" target="_blank" class="btn btn-sm btn-info">
            üìé Ver Boucher de Separaci√≥n (Referencia)
          </a>
          <p class="text-muted mt-1"><small>‚ö†Ô∏è Debes subir el boucher de la compra o inicial.</small></p>
        </div>
      {% endif %}
    </div>

    <!-- üëá Solo pedir fotos de DNI si no existen -->
    {% if cliente and cliente.dni_frontal %}
    <div class="mb-3">
      <label class="form-label">Foto DNI Frontal (Ya registrada):</label>
      <div class="border p-2 rounded">
        <img src="{{ url_for('static', filename=cliente.dni_frontal) }}" 
             class="img-thumbnail" style="max-height: 150px;" alt="DNI Frontal">
        <p class="text-muted mb-0 mt-1"><small>Ya tienes una foto registrada. No es necesario volver a subirla.</small></p>
      </div>
    </div>
    {% else %}
    <div class="mb-3">
      <label for="dni_frontal" class="form-label">Foto DNI (Frontal):</label>
      <input type="file" class="form-control" name="dni_frontal" accept="image/*" {% if not cliente or not cliente.id %}required{% endif %}>
    </div>
    {% endif %}

    {% if cliente and cliente.dni_reverso %}
    <div class="mb-3">
      <label class="form-label">Foto DNI Reverso (Ya registrada):</label>
      <div class="border p-2 rounded">
        <img src="{{ url_for('static', filename=cliente.dni_reverso) }}" 
             class="img-thumbnail" style="max-height: 150px;" alt="DNI Reverso">
        <p class="text-muted mb-0 mt-1"><small>Ya tienes una foto registrada. No es necesario volver a subirla.</small></p>
      </div>
    </div>
    {% else %}
    <div class="mb-3">
      <label for="dni_reverso" class="form-label">Foto DNI (Reverso):</label>
      <input type="file" class="form-control" name="dni_reverso" accept="image/*" {% if not cliente or not cliente.id %}required{% endif %}>
    </div>
    {% endif %}

    <div class="mb-3">
      <label for="fecha_compra" class="form-label">Fecha de Venta:</label>
      <input type="date" id="fecha_compra" name="fecha_compra" class="form-control">
    </div>

  </div>

  <input type="hidden" name="sep_id" value="{{ sep_id if sep_id else '' }}">

  <div class="col-12">
    <button type="submit" class="btn btn-success">Registrar Compra</button>
    <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<script>
  const lotesData = {};
  {% for mz, group in lotes|groupby("manzana") %}
    lotesData["{{ mz }}"] = [
      {% for l in group %}
        {id: "{{ l.id }}", numero: "{{ l.numero }}", estado: "{{ l.estado }}"},
      {% endfor %}
    ];
  {% endfor %}

  const manzanaSelect = document.getElementById("manzana");
  const loteSelect = document.getElementById("lote");

  const preselectedMz = "{{ lote.manzana if lote else '' }}";
  const preselectedLoteId = "{{ lote.id if lote else '' }}";  // üëà string

  function cargarLotes(mz) {
    loteSelect.innerHTML = '<option value="">Seleccione un lote</option>';
    if (mz && lotesData[mz]) {
      lotesData[mz].forEach(lote => {
        const option = document.createElement("option");
        option.value = lote.id;
        option.textContent = "Lt " + lote.numero;

        // üëá comparaci√≥n como string
        if (preselectedLoteId && preselectedLoteId == lote.id) {
          option.selected = true;
        }

        loteSelect.appendChild(option);
      });
    }
  }

  manzanaSelect.addEventListener("change", function () {
    cargarLotes(this.value);
  });

  if (preselectedMz) {
    manzanaSelect.value = preselectedMz;
    cargarLotes(preselectedMz);
  }

  // Mostrar/ocultar campos de cr√©dito
  const formaPagoSelect = document.querySelector("select[name='forma_pago']");
  const creditoFields = document.getElementById("creditoFields");

  function toggleCreditoFields() {
    if (formaPagoSelect.value === "credito") {
      creditoFields.style.display = "block";
    } else {
      creditoFields.style.display = "none";
      creditoFields.querySelectorAll("input").forEach(input => input.value = "");
    }
  }

  toggleCreditoFields();
  formaPagoSelect.addEventListener("change", toggleCreditoFields);
</script>

{% endblock %}