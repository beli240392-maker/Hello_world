{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h3 class="mb-3">üìë Control de Vouchers</h3>

  <!-- Formulario agregar voucher -->
  <form method="POST" enctype="multipart/form-data" class="row g-2 mb-4">
    <div class="col-md-2"><input name="codigo" class="form-control" placeholder="C√≥digo" required></div>
    <div class="col-md-2"><input name="banco" class="form-control" placeholder="Banco" required></div>
    <div class="col-md-2"><input name="nombres" class="form-control" placeholder="Nombres" required></div>
    <div class="col-md-2"><input name="apellidos" class="form-control" placeholder="Apellidos" required></div>
    <div class="col-md-2"><input name="monto" class="form-control" placeholder="Monto" required></div>
    <div class="col-md-2"><input name="proyecto" class="form-control" placeholder="Proyecto" required></div>
    <select name="lote_id" class="form-select" required>
      <option value="">Seleccionar lote...</option>
      {% for lote in lotes %}
      <option value="{{ lote.id }}">Mz {{ lote.manzana }} - Lt {{ lote.numero }}</option>
      {% endfor %}
    </select>

    <div class="col-12"><button class="btn btn-primary mt-2">‚ûï Registrar Voucher</button></div>
  </form>

  <!-- Formulario buscar voucher -->
  <form method="GET" class="mb-3">
    <div class="input-group">
      <input name="codigo" value="{{ codigo_buscar }}" class="form-control" placeholder="Buscar por c√≥digo">
      <button class="btn btn-success">üîç Buscar</button>
    </div>
  </form>

  <!-- Resultados -->
  {% if codigo_buscar %}
    {% if vouchers|length > 0 %}
      <div class="alert alert-success">‚úÖ C√≥digo encontrado.</div>
      <table id="tablaVouchers" class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>C√≥digo</th>
            <th>Banco</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>Monto</th>
            <th>Lote</th>
            <th>Proyecto</th>
            <th>Fecha</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for v in vouchers %}
            <tr>
              <td>{{ v.codigo }}</td>
              <td>{{ v.banco }}</td>
              <td>{{ v.nombres }}</td>
              <td>{{ v.apellidos }}</td>
              <td>S/ {{ '%.2f'|format(v.monto or 0) }}</td>
              <td>
                {% if v.lote %}
                  Mz {{ v.lote.manzana }} - Lt {{ v.lote.numero }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td> 
              <td>{{ v.proyecto }}</td>
              <td>{{ v.fecha_registro.strftime("%d/%m/%Y %H:%M") }}</td>
    
              <td>
                <a href="{{ url_for('editar_voucher', id=v.id) }}" class="btn btn-warning btn-sm">
                    ‚úèÔ∏è Editar
                </a>
              </td>
             
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="alert alert-danger">‚ö†Ô∏è No existe un voucher con ese c√≥digo.</div>
    {% endif %}
  {% else %}
    <!-- Mostrar todos los vouchers si no hay b√∫squeda -->
    <table id="tablaVouchers" class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>C√≥digo</th>
          <th>Banco</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Monto</th>
          <th>Lote</th>
          <th>Proyecto</th>
          <th>Fecha</th>
          <th>Acci√≥n</th>
          
        </tr>
      </thead>
      <tbody>
        {% for v in vouchers %}
          <tr>
            <td>{{ v.codigo }}</td>
            <td>{{ v.banco }}</td>
            <td>{{ v.nombres }}</td>
            <td>{{ v.apellidos }}</td>
            <td>S/ {{ '%.2f'|format(v.monto or 0) }}</td>
            <td>
              {% if v.lote %}
                Mz {{ v.lote.manzana }} - Lt {{ v.lote.numero }}
              {% else %}
                  ‚Äî
              {% endif %}
            </td>
            <td>{{ v.proyecto }}</td>
            <td>{{ v.fecha_registro.strftime("%d/%m/%Y %H:%M") }}</td>
            
            <td>
              <a href="{{ url_for('editar_voucher', id=v.id) }}" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
            </td>
            
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<!-- ‚úÖ Scripts DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  $(document).ready(function() {
    $('#tablaVouchers').DataTable({
      "pageLength": 10,            // Solo 10 entradas por p√°gina
      "lengthChange": false,       // Quita el selector de cantidad
      "searching": false,          // ‚ùå Quita el buscador
      "info": false,               // ‚ùå Quita el texto "Mostrando X de Y"
      "ordering": true,            // Permite ordenar columnas
      "language": {
        "paginate": {
          "previous": "Anterior",
          "next": "Siguiente"
        },
        "emptyTable": "No hay datos disponibles"
      }
    });
  });
</script>

{% endblock %}
